<!DOCTYPE html>
<html lang ="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>약관 등록</title>

    <!--common.css / JQuery /daterangepicker / bootstrap-->
    <link href="/css/common.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

</head>

<body>

<div class="container">




    <h2 class="head" id="division" th:text="${term != null ? '약관보기': '약관등록' }"></h2>

        <!--<form name="form" id="form" method="post" onsubmit="return check()">-->
        <!--<form name="form" id="form" method="post">-->
        <input type="hidden" id="hiddenNo" name="no" th:value="${term != null ? term.no: 0 }"/>



            <div class="first-line">
            <div>
                <span class="option">약관유형</span>
                <label for="type"></label>
                <select id="type" name="type" th:disabled="${term != null}">
                    <option value="" th:selected="${term == null}" th:disabled="${term ==null}">----- 전체 -----</option>
                    <option value="이용약관" th:selected="${term != null && term.getType()== '이용약관'}" th:disabled="${term != null && term.getType()== '이용약관'}">이용약관</option>
                    <option value="개인정보취급방침" th:selected="${term != null && term.type== '개인정보취급방침'}">개인정보취급방침</option>
                    <option value="회원가입 동의" th:selected="${term != null && term.type == '회원가입 동의'}">회원가입 동의</option>
                    <option value="주문동의" th:selected="${term != null && term.type == '주문동의'}">주문동의</option>
                </select>
            </div>

            <div>
                <span class="option">필수여부</span>
                <label for="yn"></label><input type="checkbox" id="yn"  th:checked="${term != null && term.getYn() == 'Y'}" th:disabled="${term != null && term.getYn() == 'Y' || term != null && term.getYn() == 'N'}"/>
                <input type="hidden" id="_yn" name="yn" value="N"/>
            </div>

            <div>
                <span class="option">전시 시작일</span>
                <div id="period">
                    <label for="openToEnd"></label><input class="box"  style="width:350px" type="text" id="openToEnd" autocomplete="off" th:value="${term != null ? term.getStartDate() + '~' + term.getEndDate() : ''}" />
                    <input type="hidden" id="startDateInput" name="startDate" th:value="${term != null ?  term.getStartDate() : ''}" />
                    <input type="hidden" id="endDateInput" name="endDate" th:value="${term != null ?  term.getEndDate() : ''}" />
                </div>
            </div>

        </div>


       <!-- <span id="whether-not-use">사용여부</span>
        <div>
            <label><input type="radio" name=whether_not_use"></label>사용함
            <label><input type="radio" name=whether_not_use"></label>사용안함
         </div>-->

        <div>
            <span class="option">지원언어</span>

            <div th:each="item : ${list}">
                    <input type="hidden" th:id="'hidden' + ${item.getLang()}"/>
            </div>
<!--            <th:block th:if="${term != null}">-->
                <label><input type="checkbox" id="checkboxko"  name="checkbox" value="ko"  th:disabled="${term != null}"/>국문</label>
                <label><input type="checkbox" id="checkboxen"  name="checkbox" value="en"  th:disabled="${term != null}"/>영문</label>
                <label><input type="checkbox" id="checkboxcn"  name="checkbox" value="cn"  th:disabled="${term != null}"/>중문</label>
                <label><input type="checkbox" id="checkboxjp"  name="checkbox" value="jp"  th:disabled="${term != null}"/>일문</label>
<!--            </th:block>-->

<!--            <th:block th:unless="${term != null}">-->
<!--                <label><input type="checkbox"  id="checkboxkoForNull"  value="ko" />국문</label>-->
<!--                <label><input type="checkbox"  id="checkboxenForNull"  value="en" />영문</label>-->
<!--                <label><input type="checkbox"  id="checkboxcnForNull"  value="cn" />중문</label>-->
<!--                <label><input type="checkbox"  id="checkboxjpForNull"  value="jp" />일문</label>-->
<!--            </th:block>-->

        </div>




        <div class="tableContainer">
            <table class="table">
                <tr>
                    <td class="option">약관정보</td>
                   <td>
                            <ul class="nav nav-pills" id="liParent">
                                <li class="nav-item active"  data-lang="ko"><button type="button" id="lang-ko" th:onclick="cntControll('ko')">국문</button></li>
                                <li class="nav-item active"  data-lang="en"><button type="button" id="lang-en" th:onclick="cntControll('en')">영문</button></li>
                                <li class="nav-item active"  data-lang="cn"><button type="button" id="lang-cn" th:onclick="cntControll('cn')">중문</button></li>
                                <li class="nav-item active"  data-lang="jp"><button type="button" id="lang-jp" th:onclick="cntControll('jp')">일문</button></li>
                            </ul>
                   </td>
                </tr>
                    <tr>
                        <td class="option">약관 내용</td>
                        <td colspan="4">
                            <div id="parentTextarea">
                                <th:block th:each="item : ${list}">
                                        <textarea name="" th:id="'cnt-'+${item.getLang()}" class="hidden" rows="10" cols="100"  style="display:none" th:readonly="${term != null}"> [[${term != null} ? ${item.getCnt()} : '']] </textarea>
                                </th:block>
                            </div>

<!--                            <th:block th:unless="${term != null}">-->
<!--                                    <textarea   id="cnt-ko" rows="10" cols="100" style="display:none" >  </textarea>-->
<!--                                    <textarea   id="cnt-en" rows="10" cols="100" style="display:none" >  </textarea>-->
<!--                                    <textarea   id="cnt-cn" rows="10" cols="100" style="display:none" >  </textarea>-->
<!--                                    <textarea   id="cnt-jp" rows="10" cols="100" style="display:none" >  </textarea>-->
<!--                            </th:block>-->
                        </td>
                    </tr>
            </table>
        </div>


        <div class="third-line">
            <div>
                <span class="option">등록자</span><label>
                <input type="text" th:value="${term != null} ? ${term.getRgstBy()} :''"   th:readonly="${term != null}"/>
            </label>
                <span class="option">등록일시</span><label>
                <input type="text"  th:value="${term != null} ? ${term.getStartDate()} : ''"   th:readonly="${term != null}"/>
            </label>
            </div>

<th:block th:if="${term != null}">
            <div>
                <span class="option">수정자</span>
                <label>
                    <input type="text"  th:value="${term != null} ? ${term.getMdfBy()} : ''"  th:readonly="${term != null}"/>
                </label>
                <span class="option">수정일시</span><label>
                <input type="text"   th:value="${term != null} ? ${term.getMdfDate()} : ''"  th:readonly="${term != null}"/>
            </label>
            </div>
</th:block >
        </div>

        <div class="float-center">
            <th:block th:if="${term != null}">
            <div>
                <button type="button" th:onclick="|location.href='@{/terms/}'|">뒤로가기</button>
                <button type="button">수정</button>
            </div>
            </th:block>

            <th:block th:unless="${term != null}">
                <div>
                    <button type="reset">초기화</button>
                    <button type="button" id="submitbtn" value="save">저장</button>
                </div>
            </th:block>
        </div>

<!--    </form>-->

</div> <!-- end of container-->

<!-- ajax  -->
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
<script>



/* ---------------------------------------------------------상세페이지 ----------------------------------------------------------------*/
//(ajax 사용x) 디테일 페이지 ajax 통신 대신에 데이터 한번에 가져와서 보여줌
    <!--언어 구분-->
    //let hiddenNo = document.getElementById("hiddenNo");

    // $('#liParent').on('click', 'li', function () {
    //     var selectedLang = $(this).data('lang');
    //     var param = {'no': $('#hiddenNo').val(), 'lang': selectedLang};
    //
    //
    //     $.ajax({
    //         type: "post",
    //         url: "/terms/lang",
    //         contentType: "application/json; charset=utf-8",
    //         data:
    //
    //             JSON.stringify(param),
    //
    //         dataType: "json",
    //         success: function (result) {
    //             if (result.cnt == null) {
    //                 $('#cnt').text("정보 없음");
    //             } else {
    //                 $('#cnt').text(result.cnt);
    //             }
    //         },
    //         error: function (error) {
    //             alert(" 작업 오류!!! 다시 실행해 주세요!");
    //             // return false;
    //         }
    //
    //     });
    // }); // end of $(liParent)




/*---------------------------------- 디테일 페이지 : TermDtl List  ------------------------------------*/

        if ($('#hiddenko').length) { // DB로부터 전달받은 Langs 유무에 따라 분기 // 값이 있는 경우
            $("#checkboxko").prop("checked", true);
        } else { //양식 맞춤 위해 textarea를 만들어줌//값이 없는 경우
            $('#parentTextarea').append('<textarea id ="cnt-ko" class="hidden" rows="10" cols="100"></textarea>');
        }
        if ($('#hiddenen').length) {
            $("#checkboxen").prop("checked", true);
        } else {
            $('#parentTextarea').append('<textarea id ="cnt-en" class="hidden" rows="10" cols="100"></textarea>');
        }

        if ($('#hiddencn').length) {
            $("#checkboxcn").prop("checked",  true);
        } else {
            $('#parentTextarea').append('<textarea id ="cnt-cn" class="hidden" rows="10" cols="100"></textarea>');
        }

        if ($('#hiddenjp').length) {
            $("#checkboxjp").prop("checked",  true);
        } else {
            $('#parentTextarea').append('<textarea id ="cnt-jp" class="hidden" rows="10" cols="100"></textarea>');
        }

/* ------------------------------------------------------------------------등록페이지 -----------------------------------------------------*/
    //  null check
    const isEmpty = function(value){
        return value === "" || value == null || (typeof value == "object" && !Object.keys(value).length);
    };

    // 입력값 nullCheck 필요함!
    function check() {
        // 사용자 입력 값 받아오기
        var isType = isEmpty($("#type").val());
        //var is_yn = isEmpty($("#_yn").val());
        var isStartDateInput = isEmpty($("#startDateInput").val());
        var isEndDateInput = isEmpty($("#endDateInput").val());

        //textarea
        var isTextareaKo = false;
        var isTextareaEn = false;
        var isTextareaCn = false;
        var isTextareaJp = false;

        // if ($('#checkboxkoForNull').prop('checked')) {
        //     isTextareaKo = isEmpty($('#cnt-ko').val());
        // }
        //
        // if ($('#checkboxenForNull').prop('checked')) {
        //     isTextareaEn = isEmpty($('#cnt-en').val());
        // }
        //
        // if ($('#checkboxcnForNull').prop('checked')) {
        //     isTextareaCn = isEmpty($('#cnt-cn').val());
        // }
        //
        // if ($('#checkboxjpForNull').prop('checked')) {
        //     isTextareaJp = isEmpty($('#cnt-jp').val());
        // }

        if ($('#checkboxko').prop('checked')) {
            isTextareaKo = isEmpty($('#cnt-ko').val());
        }

        if ($('#checkboxen').prop('checked')) {
            isTextareaEn = isEmpty($('#cnt-en').val());
        }

        if ($('#checkboxcn').prop('checked')) {
            isTextareaCn = isEmpty($('#cnt-cn').val());
        }

        if ($('#checkboxjp').prop('checked')) {
            isTextareaJp = isEmpty($('#cnt-jp').val());
        }


        var check1 = isType;
        //var check2 = is_yn;
        var check3 = isStartDateInput;
        var check4 = isEndDateInput;
        var check5 = isTextareaKo;
        var check6 = isTextareaEn;
        var check7 = isTextareaCn;
        var check8  = isTextareaJp;

        if (check1 || check3 || check4) {
            alert('입력되지 않은 값이 존재합니다!');
            return false;
        }

        return true;
    } // end of function check()


    //enter key 입력 --> form 제출 X
    //비동기 Input제출 하기 때문에 엔터키 방지 필요 x
    // $('#form').on ('keydown', evt => {
    //     if(evt.code === "Enter" || evt.keyCode === 13) {
    //         evt.preventDefault();
    //     }
    // });

    //checkbox 필수여부 값보내기 (checkbox는 미선택 시 아예 값도 안넘어감.)
    $("#yn").change(function() {
        var c1 = $("#yn").is(":checked") ? "Y" : "N";
        $("#_yn").val(c1);
    });




    //$("#checkboxkoForNull,#checkboxenForNull, #checkboxcnForNull, #checkboxjpForNull ").change(function() {
    // $("#checkboxko,#checkboxen, #checkboxcn, #checkboxjp").change(function() {
    //     var selectedLang = $(this).val();
    //     selectedLangArr.push(selectedLang);
    //     $(this).attr('name', 'termDtlList['+selectedLangArr.length+'].lang');
    //
    //     if (selectedLang ==="ko") {
    //         $("#cnt-ko").attr('name', 'termDtlList['+selectedLangArr.length+'].cnt');
    //     }
    //     if (selectedLang === "en") {
    //         $("#cnt-en").attr('name', 'termDtlList['+selectedLangArr.length+'].cnt');
    //     }
    //     if (selectedLang === "cn") {
    //         $("#cnt-cn").attr('name', 'termDtlList['+selectedLangArr.length+'].cnt');
    //     }
    //     if (selectedLang === "jp") {
    //         $("#cnt-jp").attr('name', 'termDtlList['+selectedLangArr.length+'].cnt');
    //     }
    // });



// ajax로 form 제출하기
        $('#submitbtn').on ('click' , function() {

            // var formsubmit = $('form').serialize(); // form값들을 queryString형태로 만들어줌
            // console.log(formsubmit);
            // console.log(JSON.stringify(formsubmit));

            if(check()) {

                var formData = {
                    type: $('#type').val(),
                    yn: $('#_yn').val(),
                    startDate: $('#startDateInput').val(),
                    endDate: $('#endDateInput').val(),
                    termDtlList: []
                };

            var selectedLangArr = [];
                //선택 언어 count
               $("input:checkbox[name=checkbox]:checked").each(function () {
                   selectedLangArr.push($(this).val());
                });

                for(const lang of selectedLangArr) {
                    //선택 언어 name 설정
                    $("#checkbox"+lang).attr('name', 'termDtlList['+selectedLangArr.length+'].lang');
                    $("#cnt-"+lang).attr('name', 'termDtlList['+selectedLangArr.length+'].cnt');

                    //선택언어  DataForm에 넣기
                    formData.termDtlList.push({
                            lang: lang,
                            cnt: $('#cnt-'+ lang).val()
                    });
                }

                // // 한국어가 체크된 경우
                // //if ($('#checkboxkoForNull').prop('checked')) {
                // if ($('#checkboxko').prop('checked')) {
                //     formData.termDtlList.push({
                //         lang: 'ko',
                //         cnt: $('#cnt-ko').val()
                //     });
                // }
                // // 영어가 체크된 경우
                // //if ($('#checkboxenForNull').prop('checked')) {
                // if ($('#checkboxen').prop('checked')) {
                //     formData.termDtlList.push({
                //         lang: 'en',
                //         cnt: $('#cnt-en').val()
                //     });
                // }
                // // 중국어가 체크된 경우
                // //if ($('#checkboxcnForNull').prop('checked')) {
                // if ($('#checkboxcn').prop('checked')) {
                //     formData.termDtlList.push({
                //         lang: 'cn',
                //         cnt: $('#cnt-cn').val()
                //     });
                // }
                // // 일본어가 체크된 경우
                // //if ($('#checkboxjpForNull').prop('checked')) {
                // if ($('#checkboxjp').prop('checked')) {
                //     formData.termDtlList.push({
                //         lang: 'jp',
                //         cnt: $('#cnt-jp').val()
                //     });
                // }

                $.ajax({
                    type: "post",
                    //data: JSON.stringify(formsubmitArray[0]),
                    // data: {
                    //   "type" :"test용"
                    // },
                    data: JSON.stringify(formData),
                    contentType:"application/json; charset=UTF-8",
                    url: "/terms/register",
                    dataType:'json',
                    timeout: 10000,
                    success: function (result) {
                        console.log('result값:' + result);
                        if(result > 0 ) {
                            alert("업로드 성공!!");
                            location.href = '/terms/';
                        } else {
                            alert("업로드 실패!!");
                            location.href = '/terms/';
                        }
                    },
                    error: function() {
                        alert(" 작업 오류!!! 다시 실행해 주세요!");
                        location.href = '/terms/';
                    }
                });
            }
            /*else {
            }*/
         });
/*-----------------------------------------공통--------------------------------------------------------*/
    // 초기페이지 국문 노출!
        $("#parentTextarea").find(".hidden").hide();
        $("#cnt-ko").show();
        // $("#cnt-ko").css('display','block');
        // $("#cnt-en,#cnt-cn,#cnt-jp").css('display','none');

    // textarea 컨트롤
    function cntControll (lang) {
        $("#parentTextarea").find('.hidden').hide();
        $("#cnt-" + lang).show();
    }

    // function cntControll (lang) {
    //     if (lang === 'ko') {
    //         // $("#cnt-ko").css('display','block');
    //         // $("#cnt-en, #cnt-cn, #cnt-jp").css('display','none');
    //         // $("#cnt-" + lang).show();
    //         // $("#cnt-en, #cnt-cn, #cnt-jp").hide();

    //
    //     } else if (lang === 'en') {
    //         $("#cnt-en").show();
    //         $("#cnt-ko, #cnt-cn, #cnt-jp").hide();
    //
    //     } else if (lang === 'cn') {
    //         $("#cnt-cn").show();
    //         $("#cnt-ko,#cnt-en,#cnt-jp" ).hide();
    //
    //
    //     } else {
    //         $("#cnt-jp").show();
    //         $("#cnt-ko, #cnt-en, #cnt-cn").hide();
    //     }
    // }

/* -----------------------------------------달력 --------------------------------------*/
    var startDate= new Date();
    var endDate = new Date();

    if ($("#startDateInput").val()) {

        var startDateInput = new Date($('#startDateInput').val());
        var years = startDateInput.getFullYear();
        var months = (startDateInput.getMonth() + 1).toString().padStart(2, '0');
        var days = startDateInput.getDate().toString().padStart(2, '0');
        startDate = years + '-' + months + '-' + days;

        var endDateInput = new Date($('#endDateInput').val());
        var yeare = endDateInput.getFullYear();
        var monthe = (endDateInput.getMonth() + 1).toString().padStart(2, '0');
        var daye = endDateInput.getDate().toString().padStart(2, '0');
        endDate = yeare + '-' + monthe + '-' + daye;

        $("#openToEnd").val(startDate + '~' + endDate ).change();
        $("#openToEnd").prop("disabled", true);

    } else {
        startDate.setMonth(endDate.getMonth() - 1);

        $(function () {
            $('#openToEnd').daterangepicker({
                "locale": {
                    "format": "YYYY-MM-DD",
                    "separator": " ~ ",
                    "applyLabel": "확인",
                    "cancelLabel": "취소",
                    "fromLabel": "From",
                    "toLabel": "To",
                    "customRangeLabel": "Custom",
                    "weekLabel": "W",
                    "daysOfWeek": ["월", "화", "수", "목", "금", "토", "일"],
                    "monthNames": ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
                    "firstDay": 1
                },
                "startDate": startDate.getFullYear() + '-' + ('0' + (startDate.getMonth() + 1)).slice(-2) + '-' + ('0' + startDate.getDate()).slice(-2),
                "endDate": endDate.getFullYear() + '-' + ('0' + (endDate.getMonth() + 1)).slice(-2) + '-' + ('0' + endDate.getDate()).slice(-2),
                "drops": "down"

            }, function (start, end, label) {

                startDate = start.format('YYYY-MM-DD');
                endDate = end.format('YYYY-MM-DD');

                $('#startDateInput').val(startDate);
                $('#endDateInput').val(endDate);

            });
        });
    }


</script>

</body>
</html>